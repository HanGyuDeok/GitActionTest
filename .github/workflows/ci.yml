name: React + Vite CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  # â† github-actions[bot]ì´ ì»¤ë°‹ & í‘¸ì‹œí•  ìˆ˜ ìˆë„ë¡

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node.js ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install
        working-directory: ./my-react-app

      - name: ì½”ë“œ ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint
        working-directory: ./my-react-app

      - name: âš™ï¸ Vite ì•± ë¹Œë“œ
        run: npm run build
        working-directory: ./my-react-app

      # --------------------- ì¶”ê°€ëœ ë¶€ë¶„ ì‹œì‘ -----------------------
      - name: ğŸ³ Docker ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: hangyudeok
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v3
        with:
          context: ./my-react-app
          push: true
          tags: hangyudeok/my-react-app:${{ github.sha }}
        # ì„¤ëª…: my-react-app ë””ë ‰í† ë¦¬ì—ì„œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ í›„ DockerHubì— í‘¸ì‹œí•©ë‹ˆë‹¤.
        # 'tags'ì— ì»¤ë°‹ SHAë¥¼ ë„£ì–´ ì´ë¯¸ì§€ ë²„ì „ì„ ê³ ìœ í•˜ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤.

      - name: ğŸ”„ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ ë° ì»¤ë°‹
        run: |
          git config --global user.name "HanGyuDeok"
          git config --global user.email "gyudeok0202@gmail.com"
          sed -i "s|image: hangyudeok/my-react-app:.*|image: hangyudeok/my-react-app:${{ github.sha }}|" ./my-react-app/k8s/deployment.yaml
          git add ./my-react-app/k8s/deployment.yaml
          git commit -m "ci: update image tag to ${{ github.sha }}"
          git push

        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ë‚´ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ìµœì‹  ì»¤ë°‹ SHAë¡œ ë³€ê²½
        # ì„¤ëª…: Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë°˜ì˜í•˜ê³ 
        # ë³€ê²½ì‚¬í•­ì„ GitHub ì €ì¥ì†Œì— ë‹¤ì‹œ í‘¸ì‹œí•©ë‹ˆë‹¤.
        # Argo CDê°€ ì´ë¥¼ ê°ì§€í•´ ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

      # --------------------- ì¶”ê°€ëœ ë¶€ë¶„ ë ---------------------

      - name: âœ… CI ì™„ë£Œ ë©”ì‹œì§€
        run: echo "ğŸ‰ Vite ê¸°ë°˜ React í”„ë¡œì íŠ¸ CI/CDê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
